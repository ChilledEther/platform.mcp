---
phase: 01-core-foundation
plan: 04
type: execute
wave: 1
depends_on: ["01-03"]
files_modified: [internal/templates/loader.go, internal/templates/manifest.yaml, pkg/scaffold/manifest.go, pkg/scaffold/scaffold.go, pkg/scaffold/scaffold_test.go]
autonomous: true
---

<objective>
Implement dynamic manifest-driven generation and support for external template directories.

Purpose: Decouple generation logic from hardcoded template mappings, enabling "drop-in" templates and customization without recompilation.
Output: Manifest-powered scaffold logic and multi-source template loader.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-foundation/01-01-SUMMARY.md
@.planning/phases/01-core-foundation/01-02-SUMMARY.md
@.planning/phases/01-core-foundation/01-03-SUMMARY.md

@pkg/scaffold/scaffold.go
@pkg/scaffold/types.go
@internal/templates/loader.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dynamic Template Loader & Global Manifest</name>
  <files>internal/templates/loader.go, internal/templates/manifest.yaml</files>
  <action>
    1. Update `internal/templates/loader.go`:
       - Add a global `BaseDir` variable and `SetBaseDir(path string)` function.
       - Update `Load(name string)` to check `filepath.Join(BaseDir, name)` first, then fall back to the embedded `fs`.
    2. Create `internal/templates/manifest.yaml`:
       - Define a list of template mappings (e.g., ci-workflow, dockerfile, flux-config).
       - Each entry should have: name, source (tmpl filename), target (output path), and a condition key.
    3. Add `GetManifest() (*Manifest, error)` to `loader.go` to parse the embedded (or external) manifest.yaml using `gopkg.in/yaml.v3`.
  </action>
  <verify>go test ./internal/templates/...</verify>
  <done>Templates can be loaded from disk or embed; manifest is parsed correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Scaffold to Manifest-Driven Logic</name>
  <files>pkg/scaffold/manifest.go, pkg/scaffold/scaffold.go, pkg/scaffold/scaffold_test.go</files>
  <action>
    1. Create `pkg/scaffold/manifest.go`:
       - Define how the `TemplateManifest` map to `Config` flags.
       - Implement a helper to filter manifest entries based on `Config`.
    2. Refactor `pkg/scaffold/scaffold.go`:
       - Replace hardcoded switch/if logic with a loop over manifest entries.
       - Use the dynamic `Load` and `Render` functions to generate files.
    3. Update `pkg/scaffold/scaffold_test.go`:
       - Add a test case that sets an external template directory and verifies it overrides the embedded one.
       - Ensure all existing table tests pass with the new logic.
  </action>
  <verify>go test ./pkg/scaffold/...</verify>
  <done>Scaffold generation is fully driven by the manifest; external templates work as expected.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./...` passes.
- [ ] `go run cmd/platform/main.go` (if exists) or equivalent check shows correct file generation.
- [ ] Manual check: Create a local .tmpl file, update manifest, and verify it generates correctly.
</verification>

<success_criteria>
- Hardcoded template mappings removed from `scaffold.go`.
- External template directory support implemented and tested.
- All generation logic driven by `internal/templates/manifest.yaml`.
- No regressions in existing functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-foundation/01-04-SUMMARY.md`
</output>
