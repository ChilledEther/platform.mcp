---
phase: 02-platform-cli
plan: 02-FIX
type: fix
source: 02-02-ISSUES.md
issue: UAT-001
autonomous: true
---

<objective>
Fix UAT-001: go.yaml workflow always generated regardless of flags.

**Root Cause:** The `workflow_go` condition in `ShouldGenerate()` returns true when `WorkflowType == "go"` (the default), regardless of whether `--with-actions` was specified. Workflow templates should only generate when `--with-actions` is explicitly set.

**Solution:** Modify the `workflow_*` conditions to require `WithActions` flag in addition to matching the workflow type.
</objective>

<context>
@.planning/phases/02-platform-cli/02-02-ISSUES.md
@pkg/scaffold/manifest.go
@internal/cli/cmd/generate.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ShouldGenerate conditions</name>
  <files>pkg/scaffold/manifest.go</files>
  <action>
    Modify the `workflow_*` condition cases to require `WithActions`:
    
    ```go
    case "workflow_go":
      return cfg.WithActions && (cfg.WorkflowType == "go" || cfg.WorkflowType == "")
    case "workflow_typescript":
      return cfg.WithActions && (cfg.WorkflowType == "typescript" || cfg.WorkflowType == "node")
    case "workflow_python":
      return cfg.WithActions && cfg.WorkflowType == "python"
    ```
    
    This ensures workflow templates only generate when `--with-actions` is set.
  </action>
  <verify>
    `go test ./pkg/scaffold/...` - Existing tests may need updating
  </verify>
  <done>
    Workflow generation requires explicit --with-actions flag
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for new behavior</name>
  <files>pkg/scaffold/manifest_test.go, internal/cli/cmd/generate_test.go</files>
  <action>
    Update tests to reflect new behavior:
    1. Tests expecting workflow generation should set `WithActions: true`
    2. Add negative test: `--with-flux` alone should NOT generate any workflow
    3. Verify `--with-actions --workflow-type=go` still works correctly
  </action>
  <verify>
    `go test ./...` passes
  </verify>
  <done>
    All tests updated and passing
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify fix with manual test</name>
  <files>None</files>
  <action>
    Run manual verification:
    1. `go run cmd/platform/main.go generate --with-flux --project-name test` → should NOT include go.yaml
    2. `go run cmd/platform/main.go generate --with-docker --project-name test` → should NOT include go.yaml  
    3. `go run cmd/platform/main.go generate --with-actions --project-name test` → SHOULD include go.yaml
  </action>
  <verify>
    Output matches expected behavior for all 3 commands
  </verify>
  <done>
    UAT-001 resolved
  </done>
</task>

</tasks>

<verification>
- [ ] `go test ./...` passes
- [ ] `--with-flux` alone generates only fluxcd.yaml
- [ ] `--with-docker` alone generates only Dockerfile + docker-build.yaml
- [ ] `--with-actions` generates workflow files as expected
</verification>

<success_criteria>
- [ ] go.yaml only appears when --with-actions is specified
- [ ] All existing functionality preserved
- [ ] Tests updated and passing
- [ ] UAT-001 moved to "Resolved" in ISSUES.md
</success_criteria>

<output>
After completion:
1. Update `.planning/phases/02-platform-cli/02-02-ISSUES.md` to move UAT-001 to Resolved
2. No separate SUMMARY needed for fix plans
</output>
